"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EcsStack = void 0;
const ecr = require("@aws-cdk/aws-ecr");
const ecs = require("@aws-cdk/aws-ecs");
const ec2 = require("@aws-cdk/aws-ec2");
const cdk = require("@aws-cdk/core");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const ecrAssets = require("@aws-cdk/aws-ecr-assets");
const path = require("path");
class EcsStack extends cdk.Construct {
    constructor(parent, id, props) {
        super(parent, id);
        const gpuAmi = new ecs.EcsOptimizedAmi({ hardwareType: ecs.AmiHardwareType.GPU });
        // configure security group for training host machine
        this.trainingSG = new ec2.SecurityGroup(this, "TrainingEndpointSG", {
            vpc: props.vpc,
            allowAllOutbound: true,
        });
        this.trainingSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(2049));
        // configure security group for inference host machine
        this.inferenceSG = new ec2.SecurityGroup(this, "InferenceEndpointSG", {
            vpc: props.vpc,
            allowAllOutbound: true,
        });
        this.inferenceSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(8080));
        const ECR_ORIGIN = parent.node.tryGetContext('EcrOrigin');
        const partition = parent.node.tryGetContext('Partition');
        // TODO: replace the following account ID and region code.
        const baseImageUri = (partition === 'aws-cn') ?
            '727897471807.dkr.ecr.cn-northwest-1.amazonaws.com.cn' :
            '763104351884.dkr.ecr.us-west-2.amazonaws.com';
        const upstreamRepoArn = (partition === 'aws-cn') ?
            `arn:aws-cn:ecr:${cdk.Aws.REGION}:753680513547:repository` :
            `arn:aws:ecr:${cdk.Aws.REGION}:366590864501:repository`;
        const trainingRepoName = 'ml-bot-training';
        const inferenceRepoName = 'ml-bot-inference';
        // Construct training image for task definition
        const trainingImageAsset = new ecrAssets.DockerImageAsset(this, 'TrainingImage', {
            directory: path.join(__dirname, '../docker/training/'),
            buildArgs: {
                REGISTRY_URI: baseImageUri
            },
            repositoryName: trainingRepoName
        });
        const trainingImageRepo = ecr.Repository.fromRepositoryAttributes(this, trainingRepoName, {
            repositoryArn: `${upstreamRepoArn}/${trainingRepoName}`,
            repositoryName: trainingRepoName
        });
        const trainingImage = (ECR_ORIGIN && ECR_ORIGIN === 'asset') ?
            ecs.ContainerImage.fromDockerImageAsset(trainingImageAsset) :
            ecs.ContainerImage.fromEcrRepository(trainingImageRepo, props.version);
        // Construct inference image for task definition
        const inferenceImageAsset = new ecrAssets.DockerImageAsset(this, 'InferenceImage', {
            directory: path.join(__dirname, '../docker/inference/'),
            buildArgs: {
                REGISTRY_URI: baseImageUri
            },
            repositoryName: inferenceRepoName
        });
        const inferenceImageRepo = ecr.Repository.fromRepositoryAttributes(this, inferenceRepoName, {
            repositoryArn: `${upstreamRepoArn}/${inferenceRepoName}`,
            repositoryName: inferenceRepoName
        });
        const inferenceImage = (ECR_ORIGIN && ECR_ORIGIN === 'asset') ?
            ecs.ContainerImage.fromDockerImageAsset(inferenceImageAsset) :
            ecs.ContainerImage.fromEcrRepository(inferenceImageRepo, props.version);
        // Create a cluster
        this.cluster = new ecs.Cluster(this, 'Cluster', { vpc: props.vpc });
        const trainingAsg = this.cluster.addCapacity('TrainingASG', {
            minCapacity: 0,
            maxCapacity: 1,
            desiredCapacity: 0,
            instanceType: new ec2.InstanceType('p3.2xlarge'),
            machineImage: gpuAmi,
            associatePublicIpAddress: false,
        });
        const inferenceAsg = this.cluster.addCapacity('InferenceASG', {
            minCapacity: 0,
            maxCapacity: 1,
            desiredCapacity: 0,
            instanceType: new ec2.InstanceType('g4dn.xlarge'),
            machineImage: gpuAmi,
            associatePublicIpAddress: false,
        });
        const s3Policy = new aws_iam_1.PolicyStatement();
        s3Policy.addActions("s3:*");
        s3Policy.addResources(props.dataBucket.bucketArn);
        s3Policy.addResources(props.dataBucket.bucketArn + "/*");
        s3Policy.addResources(props.modelBucket.bucketArn);
        s3Policy.addResources(props.modelBucket.bucketArn + "/*");
        const ecrPolicy = new aws_iam_1.PolicyStatement();
        ecrPolicy.addActions("ecr:*");
        ecrPolicy.addResources("*");
        const efsPolicy = new aws_iam_1.PolicyStatement();
        efsPolicy.addActions("elasticfilesystem:*");
        efsPolicy.addResources("*");
        trainingAsg.addToRolePolicy(s3Policy);
        trainingAsg.addToRolePolicy(ecrPolicy);
        trainingAsg.addToRolePolicy(efsPolicy);
        trainingAsg.addSecurityGroup(props.ec2SecurityGroup);
        trainingAsg.addUserData("sudo yum install -y amazon-efs-utils", "sudo systemctl enable --now amazon-ecs-volume-plugin", "sudo mkdir -p  /mnt/ml", "sudo chmod go+rw /mnt/ml", `sudo mount -t efs -o tls,accesspoint=${props.accessPointId} ${props.fileSystemId}:/ /mnt/ml`);
        trainingAsg.addSecurityGroup(this.trainingSG);
        inferenceAsg.addToRolePolicy(s3Policy);
        inferenceAsg.addToRolePolicy(ecrPolicy);
        inferenceAsg.addSecurityGroup(this.inferenceSG);
        // create a task definition with CloudWatch Logs
        const logging = new ecs.AwsLogDriver({ streamPrefix: "ml-bot" });
        const linuxParameters = new ecs.LinuxParameters(this, "LinuxParameters", {
            sharedMemorySize: 2048,
        });
        this.trainingTaskDef = new ecs.Ec2TaskDefinition(this, "TrainingTask");
        const trainingContainerDef = this.trainingTaskDef.addContainer("trainingContainer", {
            image: trainingImage,
            gpuCount: 1,
            memoryLimitMiB: 31500,
            logging: logging,
            environment: {
                DATA_BUCKET: props.dataBucket.bucketName,
                DATA_PREFIX: "",
                MODEL_BUCKET: props.modelBucket.bucketName,
                MODEL_PREFIX: "",
                AWS_DEFAULT_REGION: cdk.Aws.REGION,
            },
            linuxParameters: linuxParameters,
        });
        this.trainingTaskDef.addToExecutionRolePolicy(s3Policy);
        this.trainingTaskDef.addToExecutionRolePolicy(ecrPolicy);
        this.trainingTaskDef.addToExecutionRolePolicy(efsPolicy);
        this.trainingTaskDef.addToTaskRolePolicy(s3Policy);
        this.trainingTaskDef.addToTaskRolePolicy(ecrPolicy);
        this.trainingTaskDef.addToTaskRolePolicy(efsPolicy);
        this.trainingTaskDef.addVolume({
            name: "efs-model",
            host: {
                sourcePath: "/mnt/ml"
            }
        });
        trainingContainerDef.addMountPoints({
            containerPath: "/mnt/ml",
            readOnly: false,
            sourceVolume: "efs-model"
        });
        this.inferenceTaskDef = new ecs.Ec2TaskDefinition(this, "InferenceTask");
        this.inferenceTaskDef.addContainer("inferenceContainer", {
            image: inferenceImage,
            gpuCount: 1,
            memoryLimitMiB: 15500,
            logging,
            environment: {
                MODEL_BUCKET: props.modelBucket.bucketName,
                MODEL_PREFIX: "",
                AWS_DEFAULT_REGION: cdk.Aws.REGION,
                MXNET_CUDNN_AUTOTUNE_DEFAULT: "0",
            },
            linuxParameters: linuxParameters,
        }).addPortMappings({ containerPort: 8080, hostPort: 8080, protocol: ecs.Protocol.TCP });
        this.inferenceTaskDef.addToExecutionRolePolicy(s3Policy);
        this.inferenceTaskDef.addToExecutionRolePolicy(ecrPolicy);
        this.inferenceTaskDef.addToTaskRolePolicy(s3Policy);
        this.inferenceTaskDef.addToTaskRolePolicy(ecrPolicy);
        this.trainingAsgName = trainingAsg.autoScalingGroupName;
        this.inferenceAsgName = inferenceAsg.autoScalingGroupName;
    }
}
exports.EcsStack = EcsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWNzLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZWNzLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdDQUF3QztBQUN4Qyx3Q0FBd0M7QUFDeEMsd0NBQXdDO0FBQ3hDLHFDQUFvQztBQUVwQyw4Q0FBa0Q7QUFFbEQscURBQXNEO0FBQ3RELDZCQUE2QjtBQVk3QixNQUFhLFFBQVMsU0FBUSxHQUFHLENBQUMsU0FBUztJQVN6QyxZQUFZLE1BQXFCLEVBQUUsRUFBVSxFQUFFLEtBQW9CO1FBQ2pFLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFbEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDLEVBQUMsWUFBWSxFQUFFLEdBQUcsQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQztRQUVoRixxREFBcUQ7UUFDckQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLG9CQUFvQixFQUFFO1lBQ2xFLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztZQUNkLGdCQUFnQixFQUFFLElBQUk7U0FDdkIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXZFLHNEQUFzRDtRQUN0RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUscUJBQXFCLEVBQUU7WUFDcEUsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQ2QsZ0JBQWdCLEVBQUUsSUFBSTtTQUN2QixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8s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O0NBQ0Y7QUE5TEQsNEJBOExDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZWNyIGZyb20gJ0Bhd3MtY2RrL2F3cy1lY3InO1xuaW1wb3J0ICogYXMgZWNzIGZyb20gJ0Bhd3MtY2RrL2F3cy1lY3MnO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJ0Bhd3MtY2RrL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCJcbmltcG9ydCB7IEJ1Y2tldCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1zMyc7XG5pbXBvcnQgeyBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWlhbVwiXG5pbXBvcnQgeyBWcGMgfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWVjMlwiXG5pbXBvcnQgKiBhcyBlY3JBc3NldHMgIGZyb20gXCJAYXdzLWNkay9hd3MtZWNyLWFzc2V0c1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuZXhwb3J0IGludGVyZmFjZSBFY3NTdGFja1Byb3BzIHtcbiAgZGF0YUJ1Y2tldDogQnVja2V0LFxuICBtb2RlbEJ1Y2tldDogQnVja2V0LFxuICB2cGM6IGVjMi5JVnBjLFxuICB2ZXJzaW9uOiBzdHJpbmcsXG4gIGZpbGVTeXN0ZW1JZDogc3RyaW5nLFxuICBhY2Nlc3NQb2ludElkOiBzdHJpbmcsXG4gIGVjMlNlY3VyaXR5R3JvdXA6IGVjMi5TZWN1cml0eUdyb3VwLFxufVxuXG5leHBvcnQgY2xhc3MgRWNzU3RhY2sgZXh0ZW5kcyBjZGsuQ29uc3RydWN0IHtcbiAgcmVhZG9ubHkgY2x1c3RlcjogZWNzLkNsdXN0ZXJcbiAgcmVhZG9ubHkgdHJhaW5pbmdUYXNrRGVmOiBlY3MuRWMyVGFza0RlZmluaXRpb25cbiAgcmVhZG9ubHkgaW5mZXJlbmNlVGFza0RlZjogZWNzLkVjMlRhc2tEZWZpbml0aW9uXG4gIHJlYWRvbmx5IHRyYWluaW5nQXNnTmFtZSA6IHN0cmluZ1xuICByZWFkb25seSBpbmZlcmVuY2VBc2dOYW1lIDogc3RyaW5nXG4gIHJlYWRvbmx5IHRyYWluaW5nU0cgOiBlYzIuU2VjdXJpdHlHcm91cFxuICByZWFkb25seSBpbmZlcmVuY2VTRyA6IGVjMi5TZWN1cml0eUdyb3VwXG5cbiAgY29uc3RydWN0b3IocGFyZW50OiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogRWNzU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHBhcmVudCwgaWQpO1xuXG4gICAgY29uc3QgZ3B1QW1pID0gbmV3IGVjcy5FY3NPcHRpbWl6ZWRBbWkoe2hhcmR3YXJlVHlwZTogZWNzLkFtaUhhcmR3YXJlVHlwZS5HUFV9KTtcblxuICAgIC8vIGNvbmZpZ3VyZSBzZWN1cml0eSBncm91cCBmb3IgdHJhaW5pbmcgaG9zdCBtYWNoaW5lXG4gICAgdGhpcy50cmFpbmluZ1NHID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsIFwiVHJhaW5pbmdFbmRwb2ludFNHXCIsIHtcbiAgICAgIHZwYzogcHJvcHMudnBjLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLnRyYWluaW5nU0cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoMjA0OSkpO1xuXG4gICAgLy8gY29uZmlndXJlIHNlY3VyaXR5IGdyb3VwIGZvciBpbmZlcmVuY2UgaG9zdCBtYWNoaW5lXG4gICAgdGhpcy5pbmZlcmVuY2VTRyA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCBcIkluZmVyZW5jZUVuZHBvaW50U0dcIiwge1xuICAgICAgdnBjOiBwcm9wcy52cGMsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlLFxuICAgIH0pO1xuICAgIHRoaXMuaW5mZXJlbmNlU0cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoODA4MCkpO1xuXG4gICAgY29uc3QgRUNSX09SSUdJTiA9IHBhcmVudC5ub2RlLnRyeUdldENvbnRleHQoJ0Vjck9yaWdpbicpO1xuICAgIGNvbnN0IHBhcnRpdGlvbiA9IHBhcmVudC5ub2RlLnRyeUdldENvbnRleHQoJ1BhcnRpdGlvbicpO1xuXG4gICAgLy8gVE9ETzogcmVwbGFjZSB0aGUgZm9sbG93aW5nIGFjY291bnQgSUQgYW5kIHJlZ2lvbiBjb2RlLlxuICAgIGNvbnN0IGJhc2VJbWFnZVVyaSA9IChwYXJ0aXRpb24gPT09ICdhd3MtY24nKSA/XG4gICAgICAnNzI3ODk3NDcxODA3LmRrci5lY3IuY24tbm9ydGh3ZXN0LTEuYW1hem9uYXdzLmNvbS5jbicgOlxuICAgICAgJzc2MzEwNDM1MTg4NC5ka3IuZWNyLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tJ1xuICAgIGNvbnN0IHVwc3RyZWFtUmVwb0FybiA9IChwYXJ0aXRpb24gPT09ICdhd3MtY24nKSA/XG4gICAgICBgYXJuOmF3cy1jbjplY3I6JHtjZGsuQXdzLlJFR0lPTn06NzUzNjgwNTEzNTQ3OnJlcG9zaXRvcnlgIDpcbiAgICAgIGBhcm46YXdzOmVjcjoke2Nkay5Bd3MuUkVHSU9OfTozNjY1OTA4NjQ1MDE6cmVwb3NpdG9yeWBcbiAgICBcbiAgICBjb25zdCB0cmFpbmluZ1JlcG9OYW1lID0gJ21sLWJvdC10cmFpbmluZydcbiAgICBjb25zdCBpbmZlcmVuY2VSZXBvTmFtZSA9ICdtbC1ib3QtaW5mZXJlbmNlJ1xuXG4gICAgLy8gQ29uc3RydWN0IHRyYWluaW5nIGltYWdlIGZvciB0YXNrIGRlZmluaXRpb25cbiAgICBjb25zdCB0cmFpbmluZ0ltYWdlQXNzZXQgPSBuZXcgZWNyQXNzZXRzLkRvY2tlckltYWdlQXNzZXQodGhpcywgJ1RyYWluaW5nSW1hZ2UnLCB7XG4gICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9kb2NrZXIvdHJhaW5pbmcvJyksXG4gICAgICBidWlsZEFyZ3M6IHtcbiAgICAgICAgUkVHSVNUUllfVVJJOiBiYXNlSW1hZ2VVcmlcbiAgICAgIH0sXG4gICAgICByZXBvc2l0b3J5TmFtZTogdHJhaW5pbmdSZXBvTmFtZVxuICAgIH0pXG4gICAgY29uc3QgdHJhaW5pbmdJbWFnZVJlcG8gPSBlY3IuUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeUF0dHJpYnV0ZXModGhpcywgdHJhaW5pbmdSZXBvTmFtZSwge1xuICAgICAgcmVwb3NpdG9yeUFybjogYCR7dXBzdHJlYW1SZXBvQXJufS8ke3RyYWluaW5nUmVwb05hbWV9YCxcbiAgICAgIHJlcG9zaXRvcnlOYW1lOiB0cmFpbmluZ1JlcG9OYW1lXG4gICAgfSlcbiAgICBjb25zdCB0cmFpbmluZ0ltYWdlID0gKEVDUl9PUklHSU4gJiYgRUNSX09SSUdJTiA9PT0gJ2Fzc2V0JykgP1xuICAgICAgZWNzLkNvbnRhaW5lckltYWdlLmZyb21Eb2NrZXJJbWFnZUFzc2V0KHRyYWluaW5nSW1hZ2VBc3NldCkgOlxuICAgICAgZWNzLkNvbnRhaW5lckltYWdlLmZyb21FY3JSZXBvc2l0b3J5KHRyYWluaW5nSW1hZ2VSZXBvLCBwcm9wcy52ZXJzaW9uKVxuXG4gICAgLy8gQ29uc3RydWN0IGluZmVyZW5jZSBpbWFnZSBmb3IgdGFzayBkZWZpbml0aW9uXG4gICAgY29uc3QgaW5mZXJlbmNlSW1hZ2VBc3NldCA9IG5ldyBlY3JBc3NldHMuRG9ja2VySW1hZ2VBc3NldCh0aGlzLCAnSW5mZXJlbmNlSW1hZ2UnLCB7XG4gICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9kb2NrZXIvaW5mZXJlbmNlLycpLFxuICAgICAgYnVpbGRBcmdzOiB7XG4gICAgICAgIFJFR0lTVFJZX1VSSTogYmFzZUltYWdlVXJpXG4gICAgICB9LFxuICAgICAgcmVwb3NpdG9yeU5hbWU6IGluZmVyZW5jZVJlcG9OYW1lXG4gICAgfSlcbiAgICBjb25zdCBpbmZlcmVuY2VJbWFnZVJlcG8gPSBlY3IuUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeUF0dHJpYnV0ZXModGhpcywgaW5mZXJlbmNlUmVwb05hbWUsIHtcbiAgICAgIHJlcG9zaXRvcnlBcm46IGAke3Vwc3RyZWFtUmVwb0Fybn0vJHtpbmZlcmVuY2VSZXBvTmFtZX1gLFxuICAgICAgcmVwb3NpdG9yeU5hbWU6IGluZmVyZW5jZVJlcG9OYW1lXG4gICAgfSlcbiAgICBjb25zdCBpbmZlcmVuY2VJbWFnZSA9IChFQ1JfT1JJR0lOICYmIEVDUl9PUklHSU4gPT09ICdhc3NldCcpID9cbiAgICAgIGVjcy5Db250YWluZXJJbWFnZS5mcm9tRG9ja2VySW1hZ2VBc3NldChpbmZlcmVuY2VJbWFnZUFzc2V0KSA6XG4gICAgICBlY3MuQ29udGFpbmVySW1hZ2UuZnJvbUVjclJlcG9zaXRvcnkoaW5mZXJlbmNlSW1hZ2VSZXBvLCBwcm9wcy52ZXJzaW9uKVxuXG4gICAgLy8gQ3JlYXRlIGEgY2x1c3RlclxuICAgIHRoaXMuY2x1c3RlciA9IG5ldyBlY3MuQ2x1c3Rlcih0aGlzLCAnQ2x1c3RlcicsIHsgdnBjOiBwcm9wcy52cGMgfSk7XG4gICAgY29uc3QgdHJhaW5pbmdBc2cgPSB0aGlzLmNsdXN0ZXIuYWRkQ2FwYWNpdHkoJ1RyYWluaW5nQVNHJywge1xuICAgICAgbWluQ2FwYWNpdHk6IDAsXG4gICAgICBtYXhDYXBhY2l0eTogMSxcbiAgICAgIGRlc2lyZWRDYXBhY2l0eTogMCxcbiAgICAgIGluc3RhbmNlVHlwZTogbmV3IGVjMi5JbnN0YW5jZVR5cGUoJ3AzLjJ4bGFyZ2UnKSxcbiAgICAgIG1hY2hpbmVJbWFnZTogZ3B1QW1pLFxuICAgICAgYXNzb2NpYXRlUHVibGljSXBBZGRyZXNzOiBmYWxzZSxcbiAgICB9KTtcbiAgICBjb25zdCBpbmZlcmVuY2VBc2cgPSB0aGlzLmNsdXN0ZXIuYWRkQ2FwYWNpdHkoJ0luZmVyZW5jZUFTRycsIHtcbiAgICAgIG1pbkNhcGFjaXR5OiAwLFxuICAgICAgbWF4Q2FwYWNpdHk6IDEsXG4gICAgICBkZXNpcmVkQ2FwYWNpdHk6IDAsXG4gICAgICBpbnN0YW5jZVR5cGU6IG5ldyBlYzIuSW5zdGFuY2VUeXBlKCdnNGRuLnhsYXJnZScpLFxuICAgICAgbWFjaGluZUltYWdlOiBncHVBbWksXG4gICAgICBhc3NvY2lhdGVQdWJsaWNJcEFkZHJlc3M6IGZhbHNlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgczNQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KClcbiAgICBzM1BvbGljeS5hZGRBY3Rpb25zKFwiczM6KlwiKVxuICAgIHMzUG9saWN5LmFkZFJlc291cmNlcyhwcm9wcy5kYXRhQnVja2V0LmJ1Y2tldEFybilcbiAgICBzM1BvbGljeS5hZGRSZXNvdXJjZXMocHJvcHMuZGF0YUJ1Y2tldC5idWNrZXRBcm4gKyBcIi8qXCIpXG4gICAgczNQb2xpY3kuYWRkUmVzb3VyY2VzKHByb3BzLm1vZGVsQnVja2V0LmJ1Y2tldEFybilcbiAgICBzM1BvbGljeS5hZGRSZXNvdXJjZXMocHJvcHMubW9kZWxCdWNrZXQuYnVja2V0QXJuICsgXCIvKlwiKVxuXG4gICAgY29uc3QgZWNyUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCgpXG4gICAgZWNyUG9saWN5LmFkZEFjdGlvbnMoXCJlY3I6KlwiKVxuICAgIGVjclBvbGljeS5hZGRSZXNvdXJjZXMoXCIqXCIpXG5cbiAgICBjb25zdCBlZnNQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KClcbiAgICBlZnNQb2xpY3kuYWRkQWN0aW9ucyhcImVsYXN0aWNmaWxlc3lzdGVtOipcIilcbiAgICBlZnNQb2xpY3kuYWRkUmVzb3VyY2VzKFwiKlwiKVxuXG4gICAgdHJhaW5pbmdBc2cuYWRkVG9Sb2xlUG9saWN5KHMzUG9saWN5KVxuICAgIHRyYWluaW5nQXNnLmFkZFRvUm9sZVBvbGljeShlY3JQb2xpY3kpXG4gICAgdHJhaW5pbmdBc2cuYWRkVG9Sb2xlUG9saWN5KGVmc1BvbGljeSlcbiAgICB0cmFpbmluZ0FzZy5hZGRTZWN1cml0eUdyb3VwKHByb3BzLmVjMlNlY3VyaXR5R3JvdXApXG4gICAgdHJhaW5pbmdBc2cuYWRkVXNlckRhdGEoXG4gICAgICBcInN1ZG8geXVtIGluc3RhbGwgLXkgYW1hem9uLWVmcy11dGlsc1wiLFxuICAgICAgXCJzdWRvIHN5c3RlbWN0bCBlbmFibGUgLS1ub3cgYW1hem9uLWVjcy12b2x1bWUtcGx1Z2luXCIsXG4gICAgICBcInN1ZG8gbWtkaXIgLXAgIC9tbnQvbWxcIixcbiAgICAgIFwic3VkbyBjaG1vZCBnbytydyAvbW50L21sXCIsXG4gICAgICBgc3VkbyBtb3VudCAtdCBlZnMgLW8gdGxzLGFjY2Vzc3BvaW50PSR7cHJvcHMuYWNjZXNzUG9pbnRJZH0gJHtwcm9wcy5maWxlU3lzdGVtSWR9Oi8gL21udC9tbGBcbiAgICApXG4gICAgdHJhaW5pbmdBc2cuYWRkU2VjdXJpdHlHcm91cCh0aGlzLnRyYWluaW5nU0cpXG4gICAgaW5mZXJlbmNlQXNnLmFkZFRvUm9sZVBvbGljeShzM1BvbGljeSlcbiAgICBpbmZlcmVuY2VBc2cuYWRkVG9Sb2xlUG9saWN5KGVjclBvbGljeSlcbiAgICBpbmZlcmVuY2VBc2cuYWRkU2VjdXJpdHlHcm91cCh0aGlzLmluZmVyZW5jZVNHKVxuICAgIFxuICAgIC8vIGNyZWF0ZSBhIHRhc2sgZGVmaW5pdGlvbiB3aXRoIENsb3VkV2F0Y2ggTG9nc1xuICAgIGNvbnN0IGxvZ2dpbmcgPSBuZXcgZWNzLkF3c0xvZ0RyaXZlcih7IHN0cmVhbVByZWZpeDogXCJtbC1ib3RcIiB9KVxuICAgIGNvbnN0IGxpbnV4UGFyYW1ldGVycyA9IG5ldyBlY3MuTGludXhQYXJhbWV0ZXJzKHRoaXMsIFwiTGludXhQYXJhbWV0ZXJzXCIsIHtcbiAgICAgIHNoYXJlZE1lbW9yeVNpemU6IDIwNDgsXG4gICAgfSk7XG5cbiAgICB0aGlzLnRyYWluaW5nVGFza0RlZiA9IG5ldyBlY3MuRWMyVGFza0RlZmluaXRpb24odGhpcywgXCJUcmFpbmluZ1Rhc2tcIik7XG4gICAgY29uc3QgdHJhaW5pbmdDb250YWluZXJEZWYgPSB0aGlzLnRyYWluaW5nVGFza0RlZi5hZGRDb250YWluZXIoXCJ0cmFpbmluZ0NvbnRhaW5lclwiLCB7XG4gICAgICBpbWFnZTogdHJhaW5pbmdJbWFnZSxcbiAgICAgIGdwdUNvdW50OiAxLFxuICAgICAgbWVtb3J5TGltaXRNaUI6IDMxNTAwLFxuICAgICAgbG9nZ2luZzogbG9nZ2luZyxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIERBVEFfQlVDS0VUOiBwcm9wcy5kYXRhQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIERBVEFfUFJFRklYOiBcIlwiLFxuICAgICAgICBNT0RFTF9CVUNLRVQ6IHByb3BzLm1vZGVsQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIE1PREVMX1BSRUZJWDogXCJcIixcbiAgICAgICAgQVdTX0RFRkFVTFRfUkVHSU9OOiBjZGsuQXdzLlJFR0lPTixcbiAgICAgIH0sXG4gICAgICBsaW51eFBhcmFtZXRlcnM6IGxpbnV4UGFyYW1ldGVycyxcbiAgICB9KVxuXG4gICAgdGhpcy50cmFpbmluZ1Rhc2tEZWYuYWRkVG9FeGVjdXRpb25Sb2xlUG9saWN5KHMzUG9saWN5KVxuICAgIHRoaXMudHJhaW5pbmdUYXNrRGVmLmFkZFRvRXhlY3V0aW9uUm9sZVBvbGljeShlY3JQb2xpY3kpXG4gICAgdGhpcy50cmFpbmluZ1Rhc2tEZWYuYWRkVG9FeGVjdXRpb25Sb2xlUG9saWN5KGVmc1BvbGljeSlcbiAgICB0aGlzLnRyYWluaW5nVGFza0RlZi5hZGRUb1Rhc2tSb2xlUG9saWN5KHMzUG9saWN5KVxuICAgIHRoaXMudHJhaW5pbmdUYXNrRGVmLmFkZFRvVGFza1JvbGVQb2xpY3koZWNyUG9saWN5KVxuICAgIHRoaXMudHJhaW5pbmdUYXNrRGVmLmFkZFRvVGFza1JvbGVQb2xpY3koZWZzUG9saWN5KVxuXG4gICAgdGhpcy50cmFpbmluZ1Rhc2tEZWYuYWRkVm9sdW1lKHtcbiAgICAgIG5hbWU6IFwiZWZzLW1vZGVsXCIsXG4gICAgICBob3N0OiB7XG4gICAgICAgIHNvdXJjZVBhdGg6IFwiL21udC9tbFwiXG4gICAgICB9XG4gICAgfSlcbiAgICB0cmFpbmluZ0NvbnRhaW5lckRlZi5hZGRNb3VudFBvaW50cyh7XG4gICAgICBjb250YWluZXJQYXRoOiBcIi9tbnQvbWxcIixcbiAgICAgIHJlYWRPbmx5OiBmYWxzZSxcbiAgICAgIHNvdXJjZVZvbHVtZTogXCJlZnMtbW9kZWxcIlxuICAgIH0pXG5cbiAgICB0aGlzLmluZmVyZW5jZVRhc2tEZWYgPSBuZXcgZWNzLkVjMlRhc2tEZWZpbml0aW9uKHRoaXMsIFwiSW5mZXJlbmNlVGFza1wiKTtcbiAgICB0aGlzLmluZmVyZW5jZVRhc2tEZWYuYWRkQ29udGFpbmVyKFwiaW5mZXJlbmNlQ29udGFpbmVyXCIsIHtcbiAgICAgIGltYWdlOiBpbmZlcmVuY2VJbWFnZSxcbiAgICAgIGdwdUNvdW50OiAxLFxuICAgICAgbWVtb3J5TGltaXRNaUI6IDE1NTAwLFxuICAgICAgbG9nZ2luZyxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIE1PREVMX0JVQ0tFVDogcHJvcHMubW9kZWxCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgTU9ERUxfUFJFRklYOiBcIlwiLFxuICAgICAgICBBV1NfREVGQVVMVF9SRUdJT046IGNkay5Bd3MuUkVHSU9OLFxuICAgICAgICBNWE5FVF9DVUROTl9BVVRPVFVORV9ERUZBVUxUOiBcIjBcIixcbiAgICAgIH0sXG4gICAgICBsaW51eFBhcmFtZXRlcnM6IGxpbnV4UGFyYW1ldGVycyxcbiAgICB9KS5hZGRQb3J0TWFwcGluZ3MoXG4gICAgICB7IGNvbnRhaW5lclBvcnQ6IDgwODAsIGhvc3RQb3J0OiA4MDgwLCBwcm90b2NvbDogZWNzLlByb3RvY29sLlRDUCB9XG4gICAgKVxuXG4gICAgdGhpcy5pbmZlcmVuY2VUYXNrRGVmLmFkZFRvRXhlY3V0aW9uUm9sZVBvbGljeShzM1BvbGljeSlcbiAgICB0aGlzLmluZmVyZW5jZVRhc2tEZWYuYWRkVG9FeGVjdXRpb25Sb2xlUG9saWN5KGVjclBvbGljeSlcbiAgICB0aGlzLmluZmVyZW5jZVRhc2tEZWYuYWRkVG9UYXNrUm9sZVBvbGljeShzM1BvbGljeSlcbiAgICB0aGlzLmluZmVyZW5jZVRhc2tEZWYuYWRkVG9UYXNrUm9sZVBvbGljeShlY3JQb2xpY3kpXG5cbiAgICB0aGlzLnRyYWluaW5nQXNnTmFtZSA9IHRyYWluaW5nQXNnLmF1dG9TY2FsaW5nR3JvdXBOYW1lXG4gICAgdGhpcy5pbmZlcmVuY2VBc2dOYW1lID0gaW5mZXJlbmNlQXNnLmF1dG9TY2FsaW5nR3JvdXBOYW1lXG4gIH1cbn1cblxuIl19